package parser

import (
	"github.com/RossMerr/jsonschema"
)

var _ Types = (*Document)(nil)

type Process func(name string, schema *jsonschema.Schema) (Types, error)
type HandleSchemaFunc func(*SchemaContext, *Document, string, *jsonschema.Schema) (Types, error)

type Document struct {
	ID         string
	Package    string
	Globals    map[string]Types
	rootSchema *jsonschema.Schema
	Imports    []string
}

func NewDocument(schema *jsonschema.Schema) *Document {
	schema.SetParent("", nil)

	document := &Document{
		ID:         schema.ID.String(),
		Globals:    map[string]Types{},
		rootSchema: schema,
	}

	return document
}

func (s *Document) AddImport(value string) {
	s.Imports = append(s.Imports, value)
	s.Imports = unique(s.Imports)
}

func (s *Document) Root() *jsonschema.Schema {
	return s.rootSchema
}

func (s *Document) WithMethods(methods ...*Method) Types {
	return s
}

func (s *Document) WithReference(ref bool) Types {
	return s
}

func (s *Document) WithFieldTag(tags string) Types {
	return s
}

func (s *Document) FieldTag() string {
	return EmptyString
}

func (s *Document) Comment() string {
	return EmptyString
}

func (s *Document) Name() string {
	return EmptyString
}

func (s *Document) WithPackageName(packagename string) Types {
	s.Package = packagename
	return s
}

func unique(slice []string) []string {
	keys := make(map[string]bool)
	list := []string{}
	for _, entry := range slice {
		if _, value := keys[entry]; !value {
			keys[entry] = true
			list = append(list, entry)
		}
	}
	return list
}


const DocumentTemplate = `
// Code generated by jsonschema. DO NOT EDIT.

{{- if .Package}}
package {{.Package}}
{{else}}
package main
{{- end}}

{{range $key, $import := .Imports -}}
import "{{$import}}"
{{end}}

{{ if .ID -}}
// ID: {{.ID}}
{{ end }}

{{range $key, $global := .Globals -}}
	{{- template "kind" $global -}}
{{end}}
`
